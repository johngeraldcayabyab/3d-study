<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello Triangle MSAA</title>
</head>
<body>
<canvas id="canvas-container" width="500" height="500">
</canvas>
<script type="text/javascript">
    // MSAA explanation
    //https://www.digitaltrends.com/computing/what-is-anti-aliasing/#:~:text=Among%20all%20of%20the%20graphics,look%20terrible%20if%20harnessed%20incorrectly.
    //https://vulkan-tutorial.com/Multisampling
    (async () => {
        const triangleVertWGSL = await fetch('/web-gpu-examples/hello-triangle-msaa/triangle.vertex.wgsl').then(response => response.text());
        const redFragWGSL = await fetch('/web-gpu-examples/hello-triangle-msaa/triangle.fragment.wgsl').then(response => response.text());
        const canvas = document.getElementById("canvas-container");

        const adapter = await navigator.gpu.requestAdapter();
        const device = await adapter.requestDevice();
        // console.log(device); if you want to know the total sample counts this gpu can handle
        // view the max sample count in this object

        const context = canvas.getContext('webgpu');

        const devicePixelRatio = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * devicePixelRatio;
        canvas.height = canvas.clientHeight * devicePixelRatio;
        const presentationFormat = navigator.gpu.getPreferredCanvasFormat();

        context.configure({
            device,
            format: presentationFormat,
            alphaMode: 'premultiplied', // premultiplied is better for interpolation
        });

        const sampleCount = 4;

        const pipeline = device.createRenderPipeline({
            layout: 'auto',
            vertex: {
                module: device.createShaderModule({
                    code: triangleVertWGSL,
                }),
                entryPoint: 'main',
            },
            fragment: {
                module: device.createShaderModule({
                    code: redFragWGSL,
                }),
                entryPoint: 'main',
                targets: [
                    {
                        format: presentationFormat,
                    },
                ],
            },
            primitive: {
                topology: 'triangle-list',
            },
            multisample: {
                count: 4,
            }
        });



        const texture = device.createTexture({
            size: [canvas.width, canvas.height],
            sampleCount,
            format: presentationFormat,
            usage: GPUTextureUsage.RENDER_ATTACHMENT,
        });

        const view = texture.createView();

        function frame() {
            const commandEncoder = device.createCommandEncoder();
            const textureView = context.getCurrentTexture().createView();

            const renderPassDescriptor = {
                colorAttachments: [
                    {
                        view,
                        resolveTarget: textureView,
                        clearValue: {r: 0.0, g: 0.0, b: 0.0, a: 1.0},
                        loadOp: 'clear',
                        storeOp: 'discard',
                    },
                ],
            };

            const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);
            passEncoder.setPipeline(pipeline);
            passEncoder.draw(3, 1, 0, 0);
            passEncoder.end();

            device.queue.submit([commandEncoder.finish()]);
            requestAnimationFrame(frame);
        }

        requestAnimationFrame(frame);
    })();
</script>

</body>
</html>
