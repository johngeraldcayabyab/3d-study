<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello Triangle</title>
</head>
<body>
<canvas id="canvas-container" width="500" height="500">
</canvas>
<script src="../../main.js"></script>
<script type="text/javascript">
    (async () => {
        const triangleVertWGSL = await getWgsl('/web-gpu-examples/hello-triangle/triangle.vertex.wgsl');
        const redFragWGSL = await getWgsl('/web-gpu-examples/hello-triangle/triangle.fragment.wgsl');
        const canvas = document.getElementById("canvas-container");

        const adapter = await getAdapter();
        const device = await adapter.requestDevice();
        console.log(device);

        const context = canvas.getContext('webgpu');

        const devicePixelRatio = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * devicePixelRatio;
        canvas.height = canvas.clientHeight * devicePixelRatio;
        const presentationFormat = navigator.gpu.getPreferredCanvasFormat();

        context.configure({
            device,
            format: presentationFormat,
            alphaMode: 'premultiplied', // premultiplied is better for interpolation
        });

        const pipeline = device.createRenderPipeline({
            label: 'Hardcoded triangle pipeline',
            layout: 'auto',
            vertex: {
                module: device.createShaderModule({
                    code: triangleVertWGSL,
                }),
                entryPoint: 'main',
            },
            fragment: {
                module: device.createShaderModule({
                    code: redFragWGSL,
                }),
                entryPoint: 'main',
                targets: [
                    {
                        format: presentationFormat,
                    },
                ],
            },
            primitive: {
                topology: 'triangle-list',
            },
        });

        function frame() {
            const commandEncoder = device.createCommandEncoder();
            const textureView = context.getCurrentTexture().createView();

            const renderPassDescriptor = {
                colorAttachments: [
                    colorAttachments(textureView),
                ],
            };

            const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);
            passEncoder.setPipeline(pipeline);
            passEncoder.draw(3, 1, 0, 0);
            passEncoder.end();
            const commandBuffer = commandEncoder.finish();
            device.queue.submit([commandBuffer]);
            requestAnimationFrame(frame);
        }

        requestAnimationFrame(frame);
    })();
</script>

</body>
</html>
